# =============================================================================
# ClawBot Manager - Docker Compose Configuration
# =============================================================================
# Services:
#   - api: NestJS backend (port 3100)
#   - web: Next.js frontend (port 3000)
#   - botenv: Bot environment image (build profile only)
#
# Prerequisites:
#   - PostgreSQL and Redis should be running externally
#   - Configure DATABASE_URL and REDIS_URL in environment or .env files
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d api web      # Start only api and web
#   docker compose --profile build up # Build botenv image
# =============================================================================

x-common: &common
  platform: ${DOCKER_PLATFORM:-linux/arm64}
  restart: unless-stopped

x-healthcheck: &healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

services:
  # ---------------------------------------------------------------------------
  # Bot Environment Image (build only)
  # ---------------------------------------------------------------------------
  botenv:
    <<: *common
    profiles: ['build']
    build:
      context: .
      dockerfile: Dockerfile.botenv
      args:
        BASE_IMAGE: ${OPENCLAW_BASE_IMAGE:-openclaw:latest}
    image: ${BOTENV_IMAGE:-clawbot-env:latest}

  # ---------------------------------------------------------------------------
  # API Service - NestJS Backend
  # ---------------------------------------------------------------------------
  api:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    image: clawbot-api:latest
    container_name: clawbot-api
    env_file:
      - ./apps/api/.env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3100
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
    ports:
      - '${API_PORT:-3100}:3100'
    volumes:
      - api-logs:/app/apps/api/logs
    networks:
      - clawbot-network
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    healthcheck:
      <<: *healthcheck
      test: ['CMD', 'curl', '-f', 'http://localhost:3100/health']

  # ---------------------------------------------------------------------------
  # Web Service - Next.js Frontend
  # ---------------------------------------------------------------------------
  web:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      target: web
    image: clawbot-web:latest
    container_name: clawbot-web
    env_file:
      - ./apps/web/.env.local
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://api:3100/api}
    ports:
      - '${WEB_PORT:-3000}:3000'
    depends_on:
      api:
        condition: service_healthy
    networks:
      - clawbot-network
    healthcheck:
      <<: *healthcheck
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']

# =============================================================================
# Networks
# =============================================================================
networks:
  clawbot-network:
    name: clawbot-network
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  api-logs:
    name: clawbot-api-logs
