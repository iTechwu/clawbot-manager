# 混合架构实施计划

## 一、项目背景与现状分析

### 1.1 当前架构概述

ClawBot Manager 的代理网关（Proxy Gateway）是一个统一的 AI 模型访问层，具备以下核心能力：

**支持的 AI 提供商**：64+ 个平台

- 国际主流：OpenAI, Anthropic, Google Gemini, Azure OpenAI, AWS Bedrock, Vertex AI 等
- 国内平台：DeepSeek, 智谱, 月之暗面, 百川, 阿里百炼, 字节豆包 等
- 聚合平台：OpenRouter, 硅基流动, AiHubMix 等
- 本地部署：Ollama, LM Studio, GPUStack 等

**API 协议类型**：

```typescript
type ProviderApiType =
  | 'openai' // OpenAI 兼容 API（大多数提供商）
  | 'openai-response' // OpenAI Response API
  | 'anthropic' // Anthropic 原生 API
  | 'gemini' // Google Gemini 原生 API
  | 'azure-openai' // Azure OpenAI API
  | 'aws-bedrock' // AWS Bedrock API
  | 'vertexai' // Google Vertex AI API
  | 'ollama' // Ollama API
  | 'new-api' // New API 兼容
  | 'gateway'; // AI Gateway
```

### 1.2 当前代理流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        OpenClaw Bot Container                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  使用 OpenAI-compatible SDK 发送请求                          │   │
│  │  model: "openai-compatible/gpt-4o"                           │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Proxy Gateway                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  1. Bot Token 验证（Zero-Trust / Direct Mode）                │   │
│  │  2. 模型名称规范化（去除 provider prefix）                     │   │
│  │  3. 注入 stream_options.include_usage = true                 │   │
│  │  4. 选择 API Key（基于 tags 的动态路由）                       │   │
│  │  5. 转发到上游 API                                            │   │
│  │  6. 提取 Token 使用量并记录                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Upstream AI Provider                            │
│  OpenAI / Anthropic / Gemini / DeepSeek / ...                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 现有优势

1. **统一接口**：Bot 容器只需使用 OpenAI SDK，简化开发
2. **零信任安全**：Bot 容器不持有真实 API Key
3. **动态路由**：基于 tags 的密钥选择和负载均衡
4. **Token 追踪**：统一的使用量统计和计费
5. **多提供商支持**：64+ 提供商开箱即用

### 1.4 现有局限

1. **原生功能丢失**：
   - Claude Extended Thinking（深度推理）
   - Claude Cache Control（上下文缓存）
   - Gemini Grounding（搜索增强）
   - Gemini Code Execution（代码执行）

2. **协议转换开销**：
   - 非 OpenAI 提供商需要协议转换
   - 可能丢失特定参数和响应字段

3. **功能受限**：
   - 无法利用各提供商的差异化能力
   - 高级场景（如复杂推理）效果受限

---

## 二、Skills 与原生功能分析

### 2.1 能力来源对比

OpenClaw 的能力可以来自两个层面：

| 能力来源       | 实现方式                    | 特点                   |
| -------------- | --------------------------- | ---------------------- |
| **Skills 层**  | Function Calling + 外部服务 | 灵活、可扩展、用户可控 |
| **原生协议层** | 模型内置能力                | 深度集成、无法替代     |

### 2.2 功能可替代性分析

| 功能                  | Skills 替代方案      | 是否可替代   | 原因             |
| --------------------- | -------------------- | ------------ | ---------------- |
| **Extended Thinking** | ❌ 无                | **不可替代** | 模型内部推理能力 |
| **Cache Control**     | ❌ 无                | **不可替代** | API 层成本优化   |
| **Grounding (搜索)**  | ✅ web_search Skill  | **可替代**   | 外部搜索服务     |
| **Code Execution**    | ✅ code_runner Skill | **可替代**   | 沙箱执行环境     |

### 2.3 简化后的混合架构范围

基于以上分析，混合架构**聚焦于不可替代的原生功能**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        能力层次架构                                  │
├─────────────────────────────────────────────────────────────────────┤
│  Layer 3: Skills 扩展层                                             │
│  ├── web_search (搜索能力)                                          │
│  ├── code_runner (代码执行)                                         │
│  ├── daily_report (定时报告)                                        │
│  └── 自定义 Skills...                                               │
├─────────────────────────────────────────────────────────────────────┤
│  Layer 2: 原生协议层 (仅 Anthropic)                                  │
│  ├── Extended Thinking (深度推理)                                   │
│  └── Cache Control (成本优化)                                       │
├─────────────────────────────────────────────────────────────────────┤
│  Layer 1: 统一协议层 (OpenAI-compatible)                            │
│  └── 基础对话、Function Calling、Vision、流式响应                    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、智能路由系统设计

### 3.1 设计原则

1. **默认 OpenAI-compatible**：绝大多数场景使用统一协议
2. **Skills 优先**：可替代功能优先使用 Skills
3. **按需原生通道**：仅 Extended Thinking / Cache Control 使用原生协议
4. **向后兼容**：现有 Bot 无需修改即可继续工作
5. **成本感知**：路由决策考虑成本因素

### 3.2 能力标签路由设计

#### 3.2.1 能力标签定义

```typescript
// 能力标签 Schema
interface CapabilityTag {
  id: string;
  name: string;
  category: 'reasoning' | 'search' | 'code' | 'vision' | 'audio' | 'cost';
  priority: number; // 路由优先级
  requirements: {
    protocol?: 'openai-compatible' | 'anthropic-native';
    skills?: string[]; // 依赖的 Skills
    models?: string[]; // 支持的模型列表
  };
}

// 预定义能力标签（参考 11.1 模型目录）
const CAPABILITY_TAGS = {
  // 推理能力
  'deep-reasoning': {
    category: 'reasoning',
    priority: 100,
    requirements: {
      protocol: 'anthropic-native',
      models: ['claude-opus-4-20250514', 'claude-sonnet-4-20250514'],
    },
  },
  'fast-reasoning': {
    category: 'reasoning',
    priority: 50,
    requirements: {
      protocol: 'openai-compatible',
      models: [
        'gpt-4o',
        'claude-sonnet-4-20250514',
        'deepseek-chat',
        'o3-mini',
      ],
    },
  },

  // 搜索能力
  'web-search': {
    category: 'search',
    priority: 80,
    requirements: {
      skills: ['web_search'], // 优先使用 Skill
    },
  },

  // 代码能力
  'code-execution': {
    category: 'code',
    priority: 70,
    requirements: {
      skills: ['code_runner'], // 优先使用 Skill
    },
  },

  // 成本优化
  'cost-optimized': {
    category: 'cost',
    priority: 90,
    requirements: {
      protocol: 'anthropic-native', // Cache Control
      models: [
        'deepseek-chat',
        'gpt-4o-mini',
        'gemini-2.0-flash',
        'doubao-1.5-pro-32k',
      ],
    },
  },

  // 长上下文
  'long-context': {
    category: 'context',
    priority: 60,
    requirements: {
      protocol: 'openai-compatible',
      models: ['gemini-1.5-pro', 'gemini-2.0-flash', 'doubao-1.5-pro-256k'],
    },
  },
};
```

#### 3.2.2 路由决策流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        路由决策引擎                                  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 1: 解析请求能力需求                                            │
│  ├── 检测 thinking 参数 → deep-reasoning                            │
│  ├── 检测 cache_control → cost-optimized                            │
│  ├── 检测 tools 中的 web_search → web-search                        │
│  └── 检测 tools 中的 code_execution → code-execution                │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 2: 检查 Bot 已安装的 Skills                                    │
│  ├── 如果需要 web-search 且有 web_search Skill → 使用 Skill         │
│  ├── 如果需要 code-execution 且有 code_runner Skill → 使用 Skill    │
│  └── 否则检查是否需要原生协议                                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 3: 选择协议通道                                                │
│  ├── deep-reasoning / cost-optimized → Anthropic Native             │
│  └── 其他 → OpenAI-compatible                                       │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 4: 选择模型和 API Key                                          │
│  ├── 根据能力标签筛选可用模型                                        │
│  ├── 应用成本控制策略                                                │
│  └── 执行 Fallback 逻辑（如需要）                                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 多模型 Fallback 架构

#### 3.3.1 Fallback 策略定义

```typescript
interface FallbackStrategy {
  // 主模型
  primary: ModelConfig;

  // 备用模型链（按优先级排序）
  fallbacks: ModelConfig[];

  // 触发 Fallback 的条件
  triggers: {
    // HTTP 状态码
    statusCodes: number[]; // [429, 500, 502, 503, 504]
    // 错误类型
    errorTypes: string[]; // ['rate_limit', 'overloaded', 'timeout']
    // 超时时间（毫秒）
    timeout: number; // 30000
  };

  // Fallback 行为
  behavior: {
    // 最大重试次数
    maxRetries: number; // 3
    // 重试间隔（毫秒）
    retryDelay: number; // 1000
    // 是否保持协议一致
    preserveProtocol: boolean; // true
  };
}

// 示例：深度推理任务的 Fallback 策略（参考 11.1 模型目录）
const deepReasoningFallback: FallbackStrategy = {
  primary: {
    vendor: 'anthropic',
    model: 'claude-sonnet-4-20250514',
    protocol: 'anthropic-native',
    features: { extendedThinking: true },
  },
  fallbacks: [
    {
      vendor: 'anthropic',
      model: 'claude-opus-4-20250514',
      protocol: 'anthropic-native',
      features: { extendedThinking: true },
    },
    {
      // 降级到 OpenAI o1（有推理能力但无 Extended Thinking）
      vendor: 'openai',
      model: 'o1',
      protocol: 'openai-compatible',
      features: {},
    },
    {
      // 最终降级到高性价比模型
      vendor: 'deepseek',
      model: 'deepseek-reasoner',
      protocol: 'openai-compatible',
      features: {},
    },
  ],
  triggers: {
    statusCodes: [429, 500, 502, 503, 504],
    errorTypes: ['rate_limit', 'overloaded', 'timeout'],
    timeout: 60000,
  },
  behavior: {
    maxRetries: 3,
    retryDelay: 2000,
    preserveProtocol: false, // 允许降级到不同协议
  },
};
```

#### 3.3.2 Fallback 执行流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Fallback 执行引擎                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               │
┌───────────────────────────────────┐               │
│  尝试 Primary Model               │               │
│  claude-3-5-sonnet (Anthropic)    │               │
└───────────────────────────────────┘               │
          │                                         │
          ▼                                         │
    ┌─────────────┐                                 │
    │  成功？     │──── Yes ────────────────────────┼──→ 返回结果
    └─────────────┘                                 │
          │ No                                      │
          ▼                                         │
┌───────────────────────────────────┐               │
│  检查错误类型                      │               │
│  是否触发 Fallback？              │               │
└───────────────────────────────────┘               │
          │ Yes                                     │
          ▼                                         │
┌───────────────────────────────────┐               │
│  尝试 Fallback #1                 │               │
│  claude-3-opus (Anthropic)        │               │
└───────────────────────────────────┘               │
          │                                         │
          ▼                                         │
    ┌─────────────┐                                 │
    │  成功？     │──── Yes ────────────────────────┼──→ 返回结果
    └─────────────┘                                 │
          │ No                                      │
          ▼                                         │
┌───────────────────────────────────┐               │
│  尝试 Fallback #2 (降级)          │               │
│  gpt-4o (OpenAI-compatible)       │               │
└───────────────────────────────────┘               │
          │                                         │
          ▼                                         │
    ┌─────────────┐                                 │
    │  成功？     │──── Yes ────────────────────────┼──→ 返回结果（标记降级）
    └─────────────┘                                 │
          │ No                                      │
          ▼                                         │
┌───────────────────────────────────┐               │
│  返回错误                          │               │
│  所有模型均不可用                  │               │
└───────────────────────────────────┘               │
```

### 3.4 成本控制调度系统

#### 3.4.1 成本模型定义

```typescript
interface CostModel {
  // 模型标识
  modelId: string;

  // 基础定价（每百万 tokens）
  pricing: {
    input: number; // 输入 token 价格
    output: number; // 输出 token 价格
    cacheRead?: number; // 缓存读取价格（Anthropic）
    cacheWrite?: number; // 缓存写入价格（Anthropic）
    thinking?: number; // 思考 token 价格（Anthropic）
  };

  // 性能指标
  performance: {
    latencyMs: number; // 平均延迟
    throughput: number; // 吞吐量（tokens/s）
    reliability: number; // 可靠性（0-1）
  };

  // 能力评分
  capabilities: {
    reasoning: number; // 推理能力（0-100）
    coding: number; // 编码能力（0-100）
    creativity: number; // 创造力（0-100）
  };
}

// 成本优化策略
interface CostOptimizationStrategy {
  // 策略类型
  type: 'lowest-cost' | 'best-value' | 'performance-first' | 'balanced';

  // 约束条件
  constraints: {
    maxCostPerRequest?: number; // 单次请求最大成本
    maxLatencyMs?: number; // 最大延迟
    minCapabilityScore?: number; // 最低能力评分
  };

  // 优化权重
  weights: {
    cost: number; // 成本权重
    performance: number; // 性能权重
    capability: number; // 能力权重
  };
}
```

#### 3.4.2 成本优化决策

```typescript
// 成本优化调度器
class CostOptimizationScheduler {
  /**
   * 选择最优模型
   */
  selectOptimalModel(
    request: ProxyRequest,
    availableModels: ModelConfig[],
    strategy: CostOptimizationStrategy,
  ): ModelConfig {
    // 1. 过滤满足约束条件的模型
    const eligibleModels = availableModels.filter((model) =>
      this.meetsConstraints(model, strategy.constraints),
    );

    // 2. 计算每个模型的综合评分
    const scoredModels = eligibleModels.map((model) => ({
      model,
      score: this.calculateScore(model, request, strategy),
    }));

    // 3. 选择评分最高的模型
    return scoredModels.sort((a, b) => b.score - a.score)[0].model;
  }

  /**
   * 计算模型综合评分
   */
  private calculateScore(
    model: ModelConfig,
    request: ProxyRequest,
    strategy: CostOptimizationStrategy,
  ): number {
    const { weights } = strategy;

    // 估算请求成本
    const estimatedCost = this.estimateCost(model, request);
    const costScore = 100 - estimatedCost * 10; // 成本越低分数越高

    // 性能评分
    const performanceScore = model.performance.reliability * 100;

    // 能力评分（根据请求类型）
    const capabilityScore = this.getCapabilityScore(model, request);

    // 加权计算
    return (
      costScore * weights.cost +
      performanceScore * weights.performance +
      capabilityScore * weights.capability
    );
  }

  /**
   * 估算请求成本
   */
  private estimateCost(model: ModelConfig, request: ProxyRequest): number {
    const inputTokens = this.estimateInputTokens(request);
    const outputTokens = this.estimateOutputTokens(request);

    let cost =
      (inputTokens * model.pricing.input +
        outputTokens * model.pricing.output) /
      1_000_000;

    // 如果使用 Cache Control，调整成本估算
    if (request.features?.cacheControl && model.pricing.cacheRead) {
      const cacheHitRate = 0.7; // 假设 70% 缓存命中率
      cost = cost * (1 - cacheHitRate * 0.9); // 缓存读取便宜 90%
    }

    return cost;
  }
}
```

#### 3.4.3 成本控制策略示例

```yaml
# Bot 成本控制配置
cost_control:
  # 策略类型
  strategy: balanced

  # 预算限制
  budget:
    daily_limit: 10.00 # 每日预算（美元）
    monthly_limit: 200.00 # 每月预算
    alert_threshold: 0.8 # 80% 时告警

  # 模型偏好（参考 11.1 模型目录）
  model_preferences:
    # 简单任务使用便宜模型
    simple_tasks:
      - deepseek-chat # $0.14/M input
      - gpt-4o-mini # $0.15/M input
      - doubao-1.5-pro-32k # $0.11/M input
    # 复杂任务使用强模型
    complex_tasks:
      - claude-sonnet-4-20250514 # $3/M input
      - gpt-4o # $2.5/M input
    # 深度推理任务
    reasoning_tasks:
      - claude-opus-4-20250514 # $15/M input (支持 Extended Thinking)
      - o1 # $15/M input
      - deepseek-reasoner # $0.55/M input

  # 自动降级
  auto_downgrade:
    enabled: true
    # 当预算使用超过阈值时自动降级
    threshold: 0.9
    # 降级目标模型
    target_model: deepseek-chat
```

---

## 四、OpenClaw 配置集成

### 4.1 扩展 OpenClaw 配置结构

基于现有的 OpenClaw `config.yaml` 结构，新增路由和成本控制配置：

```yaml
# ============================================================
# OpenClaw 配置文件 - 混合架构扩展
# ============================================================

version: '1.1' # 升级版本号

# ============================================================
# AI 模型配置（增强版）
# ============================================================

llm:
  # 主模型配置（保持兼容）
  provider: openai-compatible
  api_key: '${PROXY_TOKEN}' # 使用 Proxy Token
  base_url: '${PROXY_GATEWAY_URL}'
  model: claude-sonnet-4-20250514

  # === 新增：路由配置（参考 11.1 模型目录）===
  routing:
    # 是否启用智能路由
    enabled: true

    # 路由模式
    mode: auto # auto | manual | cost-optimized

    # 能力标签映射
    capability_routing:
      # 深度推理任务
      deep_reasoning:
        protocol: anthropic-native
        models:
          - claude-sonnet-4-20250514
          - claude-opus-4-20250514
        features:
          extended_thinking: true
          thinking_budget: 20000

      # 成本优化任务
      cost_optimized:
        protocol: anthropic-native
        features:
          cache_control: true
        cache_strategy:
          system_prompt: ephemeral
          message_count: 10

      # 快速响应任务
      fast_response:
        protocol: openai-compatible
        models:
          - gpt-4o-mini
          - deepseek-chat
          - claude-3-5-haiku-20241022
          - gemini-2.0-flash

  # === 新增：Fallback 配置 ===
  fallback:
    enabled: true
    max_retries: 3
    retry_delay: 2000 # 毫秒

    # Fallback 链
    chains:
      # 默认 Fallback 链
      default:
        - provider: anthropic
          model: claude-sonnet-4-20250514
        - provider: openai
          model: gpt-4o
        - provider: deepseek
          model: deepseek-chat

      # 深度推理 Fallback 链
      deep_reasoning:
        - provider: anthropic
          model: claude-sonnet-4-20250514
          features: { extended_thinking: true }
        - provider: anthropic
          model: claude-opus-4-20250514
          features: { extended_thinking: true }
        - provider: openai
          model: o1
          # 降级：无 Extended Thinking 但有推理能力
        - provider: deepseek
          model: deepseek-reasoner
          # 最终降级：高性价比推理模型

    # 触发条件
    triggers:
      status_codes: [429, 500, 502, 503, 504]
      error_types: [rate_limit, overloaded, timeout]
      timeout_ms: 60000

  # === 新增：成本控制配置 ===
  cost_control:
    enabled: true
    strategy: balanced # lowest-cost | best-value | performance-first | balanced

    # 预算限制
    budget:
      daily_limit: 10.00
      monthly_limit: 200.00
      alert_threshold: 0.8

    # 自动降级
    auto_downgrade:
      enabled: true
      threshold: 0.9
      target_model: deepseek-chat

# ============================================================
# Skills 技能系统（增强版）
# ============================================================

skills:
  enabled: true
  path: '~/.openclaw/skills'

  # 内置技能开关
  builtin:
    daily_report: true
    morning_briefing: true
    reminder: true
    web_search: true # 替代 Gemini Grounding
    code_runner: false # 替代 Gemini Code Execution

  # === 新增：Skill 与路由集成 ===
  routing_integration:
    # 当请求需要搜索能力时
    web_search:
      # 优先使用 Skill
      prefer_skill: true
      # Skill 不可用时的 Fallback
      fallback:
        protocol: gemini-native
        feature: grounding

    #       ·
    code_execution:
      prefer_skill: true
      fallback:
        protocol: gemini-native
        feature: code_execution

# ============================================================
# 高级配置（增强版）
# ============================================================

advanced:
  # 并发请求限制
  concurrency: 5

  # 请求超时（秒）
  timeout: 120

  # === 新增：协议配置 ===
  protocols:
    # OpenAI-compatible 配置
    openai_compatible:
      stream_options:
        include_usage: true # 自动注入

    # Anthropic Native 配置
    anthropic_native:
      # Extended Thinking 默认配置
      thinking:
        default_budget: 10000
        max_budget: 50000

      # Cache Control 默认配置
      cache:
        default_ttl: 300 # 秒
        max_cached_messages: 20

  # === 新增：监控配置 ===
  monitoring:
    # Token 使用追踪
    token_tracking:
      enabled: true
      include_thinking_tokens: true
      include_cache_tokens: true

    # 成本追踪
    cost_tracking:
      enabled: true
      currency: USD
      report_interval: daily

    # 性能追踪
    performance_tracking:
      enabled: true
      metrics:
        - latency
        - throughput
        - error_rate
```

### 4.2 配置与 Proxy Gateway 的映射

```
┌─────────────────────────────────────────────────────────────────────┐
│                    OpenClaw Config → Proxy Gateway                   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  OpenClaw config.yaml                                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  llm.routing.capability_routing.deep_reasoning               │   │
│  │    protocol: anthropic-native                                │   │
│  │    features.extended_thinking: true                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 请求时携带配置
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Proxy Gateway                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  1. 解析请求中的 routing hints                               │   │
│  │  2. 检测 thinking 参数 → 路由到 Anthropic Native             │   │
│  │  3. 注入 Extended Thinking 配置                              │   │
│  │  4. 转发到 Anthropic API                                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Anthropic API (Native)                                              │
│  POST /v1/messages                                                   │
│  {                                                                   │
│    "model": "claude-3-5-sonnet-20241022",                           │
│    "thinking": { "type": "enabled", "budget_tokens": 20000 },       │
│    "messages": [...]                                                 │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.3 请求头扩展

为支持配置透传，扩展 Proxy 请求头：

```typescript
// 扩展请求头
interface ExtendedProxyHeaders {
  // 现有头
  Authorization: string; // Bot Token

  // 新增：路由提示
  'X-Routing-Hint'?: 'deep-reasoning' | 'cost-optimized' | 'fast-response';

  // 新增：协议偏好
  'X-Protocol-Preference'?: 'openai-compatible' | 'anthropic-native';

  // 新增：Fallback 控制
  'X-Fallback-Enabled'?: 'true' | 'false';
  'X-Fallback-Chain'?: string; // Fallback 链名称

  // 新增：成本控制
  'X-Cost-Strategy'?: 'lowest-cost' | 'best-value' | 'performance-first';
  'X-Max-Cost'?: string; // 单次请求最大成本
}
```

---

## 五、实施计划（修订版）

### 5.1 第一阶段：智能路由基础设施

#### 5.1.1 能力标签路由引擎

**目标**：实现基于能力标签的智能路由

**新增文件**：

- `apps/api/src/modules/proxy/services/routing-engine.service.ts`

**实现内容**：

```typescript
@Injectable()
export class RoutingEngineService {
  /**
   * 解析请求的能力需求
   */
  parseCapabilityRequirements(request: ProxyRequest): CapabilityTag[] {
    const tags: CapabilityTag[] = [];

    // 检测 Extended Thinking
    if (request.body?.thinking?.type === 'enabled') {
      tags.push(CAPABILITY_TAGS['deep-reasoning']);
    }

    // 检测 Cache Control
    if (request.body?.messages?.some((m) => m.cache_control)) {
      tags.push(CAPABILITY_TAGS['cost-optimized']);
    }

    // 检测搜索需求
    if (request.body?.tools?.some((t) => t.type === 'web_search')) {
      tags.push(CAPABILITY_TAGS['web-search']);
    }

    return tags;
  }

  /**
   * 选择最优路由
   */
  selectRoute(
    requirements: CapabilityTag[],
    botConfig: BotConfig,
  ): RouteDecision {
    // 1. 检查 Skills 是否可以满足需求
    // 2. 确定协议通道
    // 3. 选择模型
    // 4. 返回路由决策
  }
}
```

#### 5.1.2 Fallback 执行引擎

**目标**：实现多模型 Fallback 机制

**新增文件**：

- `apps/api/src/modules/proxy/services/fallback-engine.service.ts`

**实现内容**：

```typescript
@Injectable()
export class FallbackEngineService {
  /**
   * 执行带 Fallback 的请求
   */
  async executeWithFallback(
    request: ProxyRequest,
    strategy: FallbackStrategy,
  ): Promise<ProxyResponse> {
    const models = [strategy.primary, ...strategy.fallbacks];

    for (let i = 0; i < models.length; i++) {
      try {
        const response = await this.executeRequest(request, models[i]);

        // 标记是否使用了 Fallback
        if (i > 0) {
          response.metadata = {
            ...response.metadata,
            fallbackUsed: true,
            fallbackLevel: i,
            originalModel: strategy.primary.model,
            actualModel: models[i].model,
          };
        }

        return response;
      } catch (error) {
        if (this.shouldFallback(error, strategy.triggers)) {
          this.logger.warn(`Fallback triggered: ${error.message}`);
          continue;
        }
        throw error;
      }
    }

    throw new Error('All models in fallback chain failed');
  }
}
```

### 5.2 第二阶段：成本控制系统

#### 5.2.1 成本追踪服务

**目标**：实时追踪和控制成本

**新增文件**：

- `apps/api/src/modules/proxy/services/cost-tracker.service.ts`

**实现内容**：

```typescript
@Injectable()
export class CostTrackerService {
  /**
   * 记录请求成本
   */
  async recordCost(
    botId: string,
    usage: TokenUsage,
    pricing: ModelPricing,
  ): Promise<void> {
    const cost = this.calculateCost(usage, pricing);

    await this.botUsageLogService.updateCost(botId, {
      inputCost: cost.input,
      outputCost: cost.output,
      thinkingCost: cost.thinking,
      cacheCost: cost.cache,
      totalCost: cost.total,
    });

    // 检查预算
    await this.checkBudget(botId, cost.total);
  }

  /**
   * 检查预算并触发告警/降级
   */
  private async checkBudget(botId: string, cost: number): Promise<void> {
    const budget = await this.getBotBudget(botId);
    const usage = await this.getDailyUsage(botId);

    const usageRatio = (usage + cost) / budget.dailyLimit;

    if (usageRatio >= 1.0) {
      // 触发自动降级
      await this.triggerAutoDowngrade(botId);
    } else if (usageRatio >= budget.alertThreshold) {
      // 发送告警
      await this.sendBudgetAlert(botId, usageRatio);
    }
  }
}
```

### 5.3 第三阶段：Anthropic 原生通道

#### 5.3.1 原生协议处理器

**目标**：支持 Anthropic 原生 API（Extended Thinking + Cache Control）

**新增文件**：

- `apps/api/src/modules/proxy/handlers/anthropic-native.handler.ts`

**实现内容**：

```typescript
@Injectable()
export class AnthropicNativeHandler {
  /**
   * 处理 Anthropic 原生请求
   */
  async handle(
    request: AnthropicNativeRequest,
    rawResponse: ServerResponse,
  ): Promise<ProxyResult> {
    // 1. 验证 Bot Token
    const validation = await this.validateToken(request.botToken);

    // 2. 选择 Anthropic API Key
    const apiKey = await this.selectApiKey(validation.botId, 'anthropic');

    // 3. 透传请求（保留 thinking、cache_control 等原生参数）
    const response = await this.forwardToAnthropic(request, apiKey);

    // 4. 提取 Token 使用量（包括 thinking_tokens、cache_*_tokens）
    const usage = this.extractUsage(response);

    // 5. 记录使用日志和成本
    await this.logUsage(validation.botId, usage);

    return response;
  }

  /**
   * 提取 Anthropic 原生响应的 Token 使用量
   */
  private extractUsage(response: AnthropicResponse): ExtendedTokenUsage {
    return {
      inputTokens: response.usage.input_tokens,
      outputTokens: response.usage.output_tokens,
      // Extended Thinking tokens
      thinkingTokens: response.usage.thinking_tokens,
      // Cache Control tokens
      cacheReadTokens: response.usage.cache_read_input_tokens,
      cacheWriteTokens: response.usage.cache_creation_input_tokens,
    };
  }
}
```

### 5.4 第四阶段：OpenClaw 客户端集成

#### 5.4.1 配置解析器

**目标**：解析 OpenClaw 配置并生成路由策略

**修改文件**：

- `apps/api/libs/infra/clients/internal/openclaw/openclaw.client.ts`

**新增接口**：

```typescript
interface OpenClawClientConfig {
  // 基础配置
  proxyUrl: string;
  botToken: string;

  // 路由配置
  routing?: {
    enabled: boolean;
    mode: 'auto' | 'manual' | 'cost-optimized';
    capabilityRouting?: Record<string, CapabilityRoutingConfig>;
  };

  // Fallback 配置
  fallback?: {
    enabled: boolean;
    chains: Record<string, FallbackChain>;
  };

  // 成本控制配置
  costControl?: {
    enabled: boolean;
    strategy: CostStrategy;
    budget: BudgetConfig;
  };
}

class OpenClawClient {
  constructor(config: OpenClawClientConfig) {
    this.routingEngine = new RoutingEngine(config.routing);
    this.fallbackEngine = new FallbackEngine(config.fallback);
    this.costOptimizer = new CostOptimizer(config.costControl);
  }

  /**
   * 智能对话（自动路由）
   */
  async chat(messages: Message[], options?: ChatOptions): Promise<Response> {
    // 1. 解析能力需求
    const requirements = this.routingEngine.parseRequirements(options);

    // 2. 选择路由
    const route = this.routingEngine.selectRoute(requirements);

    // 3. 应用成本优化
    const optimizedRoute = this.costOptimizer.optimize(route);

    // 4. 执行请求（带 Fallback）
    return this.fallbackEngine.execute(messages, optimizedRoute);
  }

  /**
   * 深度推理（自动使用 Anthropic Extended Thinking）
   */
  async deepReasoning(
    prompt: string,
    options?: ReasoningOptions,
  ): Promise<Response> {
    return this.chat([{ role: 'user', content: prompt }], {
      routingHint: 'deep-reasoning',
      features: { extendedThinking: true },
      ...options,
    });
  }
}
```

---

## 六、数据库变更

### 6.1 BotUsageLog 表扩展

```prisma
model BotUsageLog {
  // ... 现有字段 ...

  // 新增字段：原生功能使用追踪
  thinkingTokens      Int?      // Extended Thinking tokens
  cacheReadTokens     Int?      // Cache Control 读取 tokens
  cacheWriteTokens    Int?      // Cache Control 写入 tokens
  groundingQueries    Int?      // Grounding 搜索次数
  codeExecutions      Int?      // Code Execution 执行次数

  // 协议类型
  protocolType        String?   // 'openai-compatible' | 'anthropic-native' | 'gemini-native'

  // 成本追踪
  inputCost           Decimal?  // 输入成本
  outputCost          Decimal?  // 输出成本
  thinkingCost        Decimal?  // 思考成本
  cacheCost           Decimal?  // 缓存成本
  totalCost           Decimal?  // 总成本

  // Fallback 追踪
  fallbackUsed        Boolean?  // 是否使用了 Fallback
  fallbackLevel       Int?      // Fallback 级别
  originalModel       String?   // 原始请求模型
}
```

### 6.2 ModelPricing 表扩展

```prisma
model ModelPricing {
  // ... 现有字段 ...

  // 新增字段：原生功能定价
  thinkingInputPrice   Decimal?  // thinking tokens 输入价格
  thinkingOutputPrice  Decimal?  // thinking tokens 输出价格
  cacheReadPrice       Decimal?  // cache read 价格（通常是 input 的 10%）
  cacheWritePrice      Decimal?  // cache write 价格
  groundingPrice       Decimal?  // grounding 每次查询价格
  codeExecutionPrice   Decimal?  // code execution 每次执行价格
}
```

### 6.3 BotRoutingConfig 新表

```prisma
model BotRoutingConfig {
  id                  String    @id @default(uuid())
  botId               String
  bot                 Bot       @relation(fields: [botId], references: [id])

  // 路由配置
  routingEnabled      Boolean   @default(true)
  routingMode         String    @default("auto")  // auto | manual | cost-optimized

  // Fallback 配置
  fallbackEnabled     Boolean   @default(true)
  fallbackChains      Json?     // Fallback 链配置

  // 成本控制配置
  costControlEnabled  Boolean   @default(false)
  costStrategy        String?   // lowest-cost | best-value | performance-first | balanced
  dailyBudget         Decimal?
  monthlyBudget       Decimal?
  alertThreshold      Decimal?  @default(0.8)
  autoDowngrade       Boolean   @default(false)
  downgradeModel      String?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}
```

### 6.4 ModelCatalog 新表（模型目录）

```prisma
/// 模型目录 - 存储所有可用模型的元数据
model ModelCatalog {
  id                  String    @id @default(uuid())

  // 模型标识
  modelId             String    @unique  // e.g., "claude-sonnet-4-20250514"
  vendor              String    // e.g., "anthropic", "openai", "deepseek"
  displayName         String    // e.g., "Claude Sonnet 4"
  description         String?   // 模型描述

  // 定价（每百万 tokens，美元）
  inputPrice          Decimal   // 输入 token 价格
  outputPrice         Decimal   // 输出 token 价格
  cacheReadPrice      Decimal?  // 缓存读取价格（Anthropic）
  cacheWritePrice     Decimal?  // 缓存写入价格（Anthropic）
  thinkingPrice       Decimal?  // 思考 token 价格（Anthropic Extended Thinking）

  // 能力评分（0-100）
  reasoningScore      Int       @default(50)  // 推理能力
  codingScore         Int       @default(50)  // 编码能力
  creativityScore     Int       @default(50)  // 创造力
  speedScore          Int       @default(50)  // 响应速度
  contextLength       Int       @default(128) // 上下文长度（K tokens）

  // 特性支持
  supportsExtendedThinking  Boolean @default(false)
  supportsCacheControl      Boolean @default(false)
  supportsVision            Boolean @default(false)
  supportsFunctionCalling   Boolean @default(true)
  supportsStreaming         Boolean @default(true)

  // 推荐场景（JSON 数组）
  recommendedScenarios      Json?   // ["deep-reasoning", "coding", "general-purpose"]

  // 状态
  isActive            Boolean   @default(true)
  isDeprecated        Boolean   @default(false)
  deprecationDate     DateTime?

  // 元数据
  metadata            Json?     // 其他扩展信息

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([vendor])
  @@index([isActive])
}
```

### 6.5 CapabilityTag 新表（能力标签）

```prisma
/// 能力标签 - 定义路由能力标签及其要求
model CapabilityTag {
  id                  String    @id @default(uuid())

  // 标签标识
  tagId               String    @unique  // e.g., "deep-reasoning", "cost-optimized"
  name                String    // 显示名称
  description         String?   // 标签描述

  // 分类
  category            String    // reasoning | search | code | vision | audio | cost | context

  // 路由优先级（数值越高优先级越高）
  priority            Int       @default(50)

  // 路由要求
  requiredProtocol    String?   // "openai-compatible" | "anthropic-native" | null
  requiredSkills      Json?     // ["web_search", "code_runner"]
  requiredModels      Json?     // ["claude-sonnet-4-*", "gpt-4o"]

  // 特性要求
  requiresExtendedThinking  Boolean @default(false)
  requiresCacheControl      Boolean @default(false)
  requiresVision            Boolean @default(false)

  // 成本约束
  maxCostPerMToken    Decimal?  // 单次请求最大成本约束

  // 状态
  isActive            Boolean   @default(true)
  isBuiltin           Boolean   @default(false)  // 是否为内置标签

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([category])
  @@index([isActive])
}
```

### 6.6 FallbackChain 新表（Fallback 链配置）

```prisma
/// Fallback 链 - 定义模型降级策略
model FallbackChain {
  id                  String    @id @default(uuid())

  // 链标识
  chainId             String    @unique  // e.g., "default", "deep-reasoning", "cost-optimized"
  name                String    // 显示名称
  description         String?   // 链描述

  // 链配置（JSON 数组，按优先级排序）
  // [{ vendor: "anthropic", model: "claude-sonnet-4", protocol: "anthropic-native", features: {...} }]
  models              Json

  // 触发条件
  triggerStatusCodes  Json      @default("[429, 500, 502, 503, 504]")
  triggerErrorTypes   Json      @default("[\"rate_limit\", \"overloaded\", \"timeout\"]")
  triggerTimeoutMs    Int       @default(60000)

  // 行为配置
  maxRetries          Int       @default(3)
  retryDelayMs        Int       @default(2000)
  preserveProtocol    Boolean   @default(false)  // 是否保持协议一致

  // 状态
  isActive            Boolean   @default(true)
  isBuiltin           Boolean   @default(false)  // 是否为内置链

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}
```

### 6.7 CostStrategy 新表（成本策略配置）

```prisma
/// 成本策略 - 定义成本优化策略
model CostStrategy {
  id                  String    @id @default(uuid())

  // 策略标识
  strategyId          String    @unique  // e.g., "lowest-cost", "best-value", "balanced"
  name                String    // 显示名称
  description         String?   // 策略描述

  // 优化权重（0-1，总和为 1）
  costWeight          Decimal   @default(0.5)       // 成本权重
  performanceWeight   Decimal   @default(0.3)       // 性能权重
  capabilityWeight    Decimal   @default(0.2)       // 能力权重

  // 约束条件
  maxCostPerRequest   Decimal?  // 单次请求最大成本
  maxLatencyMs        Int?      // 最大延迟
  minCapabilityScore  Int?      // 最低能力评分

  // 场景权重配置（JSON）
  // { "reasoning": 0.5, "coding": 0.3, "creativity": 0.2, "speed": 0.5 }
  scenarioWeights     Json?

  // 状态
  isActive            Boolean   @default(true)
  isBuiltin           Boolean   @default(false)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}
```

---

## 七、API 变更

### 7.1 新增端点

#### 7.1.1 代理端点

| 端点                           | 方法       | 描述                   |
| ------------------------------ | ---------- | ---------------------- |
| `/proxy/anthropic/v1/messages` | POST       | Anthropic 原生消息 API |
| `/proxy/anthropic/v1/messages` | POST (SSE) | Anthropic 原生流式 API |

#### 7.1.2 Bot 路由配置端点

| 端点                                | 方法 | 描述                  |
| ----------------------------------- | ---- | --------------------- |
| `/api/bot/:hostname/routing-config` | GET  | 获取 Bot 路由配置     |
| `/api/bot/:hostname/routing-config` | PUT  | 更新 Bot 路由配置     |
| `/api/bot/:hostname/cost-usage`     | GET  | 获取 Bot 成本使用统计 |

#### 7.1.3 模型目录管理端点（管理员）

| 端点                                             | 方法   | 描述                      |
| ------------------------------------------------ | ------ | ------------------------- |
| `/api/admin/model-catalog`                       | GET    | 获取所有模型目录          |
| `/api/admin/model-catalog`                       | POST   | 创建模型条目              |
| `/api/admin/model-catalog/:modelId`              | GET    | 获取单个模型详情          |
| `/api/admin/model-catalog/:modelId`              | PUT    | 更新模型信息              |
| `/api/admin/model-catalog/:modelId`              | DELETE | 删除模型条目              |
| `/api/admin/model-catalog/:modelId/pricing`      | PUT    | 更新模型定价              |
| `/api/admin/model-catalog/:modelId/capabilities` | PUT    | 更新模型能力评分          |
| `/api/admin/model-catalog/sync`                  | POST   | 从提供商 API 同步模型信息 |

#### 7.1.4 能力标签管理端点（管理员）

| 端点                                | 方法   | 描述             |
| ----------------------------------- | ------ | ---------------- |
| `/api/admin/capability-tags`        | GET    | 获取所有能力标签 |
| `/api/admin/capability-tags`        | POST   | 创建能力标签     |
| `/api/admin/capability-tags/:tagId` | GET    | 获取单个标签详情 |
| `/api/admin/capability-tags/:tagId` | PUT    | 更新能力标签     |
| `/api/admin/capability-tags/:tagId` | DELETE | 删除能力标签     |

#### 7.1.5 Fallback 链管理端点（管理员）

| 端点                                  | 方法   | 描述                 |
| ------------------------------------- | ------ | -------------------- |
| `/api/admin/fallback-chains`          | GET    | 获取所有 Fallback 链 |
| `/api/admin/fallback-chains`          | POST   | 创建 Fallback 链     |
| `/api/admin/fallback-chains/:chainId` | GET    | 获取单个链详情       |
| `/api/admin/fallback-chains/:chainId` | PUT    | 更新 Fallback 链     |
| `/api/admin/fallback-chains/:chainId` | DELETE | 删除 Fallback 链     |

#### 7.1.6 成本策略管理端点（管理员）

| 端点                                     | 方法   | 描述             |
| ---------------------------------------- | ------ | ---------------- |
| `/api/admin/cost-strategies`             | GET    | 获取所有成本策略 |
| `/api/admin/cost-strategies`             | POST   | 创建成本策略     |
| `/api/admin/cost-strategies/:strategyId` | GET    | 获取单个策略详情 |
| `/api/admin/cost-strategies/:strategyId` | PUT    | 更新成本策略     |
| `/api/admin/cost-strategies/:strategyId` | DELETE | 删除成本策略     |

### 7.2 现有端点增强

| 端点               | 变更 | 描述                                 |
| ------------------ | ---- | ------------------------------------ |
| `/proxy/:vendor/*` | 增强 | 支持协议自动检测、Fallback、成本控制 |

### 7.3 新增请求头

| 请求头                  | 描述                                                        |
| ----------------------- | ----------------------------------------------------------- |
| `X-Routing-Hint`        | 路由提示（deep-reasoning / cost-optimized / fast-response） |
| `X-Protocol-Preference` | 协议偏好（openai-compatible / anthropic-native）            |
| `X-Fallback-Enabled`    | 是否启用 Fallback                                           |
| `X-Cost-Strategy`       | 成本策略                                                    |
| `X-Max-Cost`            | 单次请求最大成本                                            |

---

## 八、风险与缓解

### 8.1 技术风险

| 风险                    | 影响 | 缓解措施                   |
| ----------------------- | ---- | -------------------------- |
| 协议兼容性问题          | 中   | 充分测试，渐进式发布       |
| Token 提取不准确        | 中   | 完善各协议的解析逻辑       |
| Fallback 链过长导致延迟 | 中   | 设置最大重试次数和超时     |
| 成本估算不准确          | 低   | 使用实际定价数据，定期校准 |

### 8.2 业务风险

| 风险             | 影响 | 缓解措施               |
| ---------------- | ---- | ---------------------- |
| 原生功能成本更高 | 中   | 明确计费规则，用户可控 |
| 学习曲线增加     | 低   | 提供清晰文档和示例     |
| 预算超支         | 中   | 自动降级和告警机制     |

---

## 九、测试计划

### 9.1 单元测试

- [ ] 能力标签路由引擎测试
- [ ] Fallback 执行引擎测试
- [ ] 成本计算和追踪测试
- [ ] Token 提取器各格式测试

### 9.2 集成测试

- [ ] Anthropic 原生通道端到端测试
- [ ] 多模型 Fallback 链测试
- [ ] 成本控制和自动降级测试
- [ ] OpenClaw 配置集成测试

### 9.3 性能测试

- [ ] 路由决策延迟测试
- [ ] Fallback 切换延迟测试
- [ ] 大流量下的稳定性测试

---

## 十、里程碑（修订版）

| 阶段    | 目标                | 交付物                                |
| ------- | ------------------- | ------------------------------------- |
| Phase 1 | 智能路由基础设施    | 能力标签路由引擎、Fallback 执行引擎   |
| Phase 2 | 成本控制系统        | 成本追踪服务、成本优化调度器          |
| Phase 3 | Anthropic 原生通道  | Extended Thinking、Cache Control 支持 |
| Phase 4 | OpenClaw 客户端集成 | 配置解析、路由策略生成                |

---

## 十一、附录

### 11.1 模型目录（Model Catalog）

#### 11.1.1 模型定价与能力评分

```typescript
// 模型目录定义
interface ModelCatalogEntry {
  id: string;
  vendor: ProviderVendor;
  displayName: string;

  // 定价（每百万 tokens，美元）
  pricing: {
    input: number;
    output: number;
    cacheRead?: number; // Anthropic Cache Control
    cacheWrite?: number; // Anthropic Cache Control
    thinking?: number; // Anthropic Extended Thinking
  };

  // 能力评分（0-100）
  capabilities: {
    reasoning: number; // 推理能力
    coding: number; // 编码能力
    creativity: number; // 创造力
    speed: number; // 响应速度
    contextLength: number; // 上下文长度（K tokens）
  };

  // 特性支持
  features: {
    extendedThinking?: boolean;
    cacheControl?: boolean;
    vision?: boolean;
    functionCalling?: boolean;
    streaming?: boolean;
  };

  // 推荐场景
  recommendedFor: string[];
}

// ============================================================
// Anthropic Claude 系列
// ============================================================
const CLAUDE_MODELS: ModelCatalogEntry[] = [
  {
    id: 'claude-opus-4-20250514',
    vendor: 'anthropic',
    displayName: 'Claude Opus 4',
    pricing: {
      input: 15.0,
      output: 75.0,
      cacheRead: 1.5,
      cacheWrite: 18.75,
      thinking: 15.0,
    },
    capabilities: {
      reasoning: 100,
      coding: 98,
      creativity: 95,
      speed: 60,
      contextLength: 200,
    },
    features: {
      extendedThinking: true,
      cacheControl: true,
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['deep-reasoning', 'complex-analysis', 'research'],
  },
  {
    id: 'claude-sonnet-4-20250514',
    vendor: 'anthropic',
    displayName: 'Claude Sonnet 4',
    pricing: {
      input: 3.0,
      output: 15.0,
      cacheRead: 0.3,
      cacheWrite: 3.75,
      thinking: 3.0,
    },
    capabilities: {
      reasoning: 92,
      coding: 95,
      creativity: 90,
      speed: 80,
      contextLength: 200,
    },
    features: {
      extendedThinking: true,
      cacheControl: true,
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['coding', 'general-purpose', 'cost-optimized'],
  },
  {
    id: 'claude-3-5-haiku-20241022',
    vendor: 'anthropic',
    displayName: 'Claude 3.5 Haiku',
    pricing: {
      input: 0.8,
      output: 4.0,
      cacheRead: 0.08,
      cacheWrite: 1.0,
    },
    capabilities: {
      reasoning: 75,
      coding: 80,
      creativity: 70,
      speed: 95,
      contextLength: 200,
    },
    features: {
      cacheControl: true,
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['fast-response', 'simple-tasks', 'high-volume'],
  },
];

// ============================================================
// OpenAI GPT 系列
// ============================================================
const OPENAI_MODELS: ModelCatalogEntry[] = [
  {
    id: 'gpt-4o',
    vendor: 'openai',
    displayName: 'GPT-4o',
    pricing: {
      input: 2.5,
      output: 10.0,
    },
    capabilities: {
      reasoning: 90,
      coding: 92,
      creativity: 88,
      speed: 85,
      contextLength: 128,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['general-purpose', 'multimodal', 'coding'],
  },
  {
    id: 'gpt-4o-mini',
    vendor: 'openai',
    displayName: 'GPT-4o Mini',
    pricing: {
      input: 0.15,
      output: 0.6,
    },
    capabilities: {
      reasoning: 75,
      coding: 78,
      creativity: 72,
      speed: 95,
      contextLength: 128,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['fast-response', 'cost-optimized', 'simple-tasks'],
  },
  {
    id: 'o1',
    vendor: 'openai',
    displayName: 'OpenAI o1',
    pricing: {
      input: 15.0,
      output: 60.0,
    },
    capabilities: {
      reasoning: 98,
      coding: 95,
      creativity: 85,
      speed: 50,
      contextLength: 200,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['deep-reasoning', 'math', 'science'],
  },
  {
    id: 'o3-mini',
    vendor: 'openai',
    displayName: 'OpenAI o3-mini',
    pricing: {
      input: 1.1,
      output: 4.4,
    },
    capabilities: {
      reasoning: 88,
      coding: 90,
      creativity: 75,
      speed: 80,
      contextLength: 200,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['reasoning', 'coding', 'cost-optimized'],
  },
];

// ============================================================
// Google Gemini 系列
// ============================================================
const GEMINI_MODELS: ModelCatalogEntry[] = [
  {
    id: 'gemini-2.0-flash',
    vendor: 'google',
    displayName: 'Gemini 2.0 Flash',
    pricing: {
      input: 0.1,
      output: 0.4,
    },
    capabilities: {
      reasoning: 82,
      coding: 85,
      creativity: 80,
      speed: 95,
      contextLength: 1000,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['fast-response', 'long-context', 'multimodal'],
  },
  {
    id: 'gemini-2.0-flash-thinking',
    vendor: 'google',
    displayName: 'Gemini 2.0 Flash Thinking',
    pricing: {
      input: 0.1,
      output: 0.4,
    },
    capabilities: {
      reasoning: 90,
      coding: 88,
      creativity: 82,
      speed: 85,
      contextLength: 1000,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['reasoning', 'analysis', 'long-context'],
  },
  {
    id: 'gemini-1.5-pro',
    vendor: 'google',
    displayName: 'Gemini 1.5 Pro',
    pricing: {
      input: 1.25,
      output: 5.0,
    },
    capabilities: {
      reasoning: 88,
      coding: 90,
      creativity: 85,
      speed: 75,
      contextLength: 2000,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['long-context', 'document-analysis', 'coding'],
  },
];

// ============================================================
// DeepSeek 系列
// ============================================================
const DEEPSEEK_MODELS: ModelCatalogEntry[] = [
  {
    id: 'deepseek-chat',
    vendor: 'deepseek',
    displayName: 'DeepSeek Chat (V3)',
    pricing: {
      input: 0.14,
      output: 0.28,
    },
    capabilities: {
      reasoning: 85,
      coding: 92,
      creativity: 80,
      speed: 90,
      contextLength: 64,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['cost-optimized', 'coding', 'general-purpose'],
  },
  {
    id: 'deepseek-reasoner',
    vendor: 'deepseek',
    displayName: 'DeepSeek Reasoner (R1)',
    pricing: {
      input: 0.55,
      output: 2.19,
    },
    capabilities: {
      reasoning: 95,
      coding: 93,
      creativity: 78,
      speed: 70,
      contextLength: 64,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['deep-reasoning', 'math', 'coding'],
  },
];

// ============================================================
// 字节豆包 (Doubao) 系列
// ============================================================
const DOUBAO_MODELS: ModelCatalogEntry[] = [
  {
    id: 'doubao-1.5-pro-32k',
    vendor: 'doubao',
    displayName: '豆包 1.5 Pro 32K',
    pricing: {
      input: 0.0008, // ¥0.0008/千tokens ≈ $0.11/M
      output: 0.002, // ¥0.002/千tokens ≈ $0.28/M
    },
    capabilities: {
      reasoning: 82,
      coding: 85,
      creativity: 80,
      speed: 90,
      contextLength: 32,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['cost-optimized', 'chinese-tasks', 'general-purpose'],
  },
  {
    id: 'doubao-1.5-pro-256k',
    vendor: 'doubao',
    displayName: '豆包 1.5 Pro 256K',
    pricing: {
      input: 0.005, // ¥0.005/千tokens ≈ $0.69/M
      output: 0.009, // ¥0.009/千tokens ≈ $1.24/M
    },
    capabilities: {
      reasoning: 82,
      coding: 85,
      creativity: 80,
      speed: 85,
      contextLength: 256,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['long-context', 'document-analysis', 'chinese-tasks'],
  },
  {
    id: 'doubao-1.5-thinking-pro',
    vendor: 'doubao',
    displayName: '豆包 1.5 Thinking Pro',
    pricing: {
      input: 0.004, // ¥0.004/千tokens ≈ $0.55/M
      output: 0.016, // ¥0.016/千tokens ≈ $2.21/M
    },
    capabilities: {
      reasoning: 90,
      coding: 88,
      creativity: 82,
      speed: 75,
      contextLength: 128,
    },
    features: {
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['reasoning', 'analysis', 'chinese-tasks'],
  },
];

// ============================================================
// xAI Grok 系列
// ============================================================
const GROK_MODELS: ModelCatalogEntry[] = [
  {
    id: 'grok-2',
    vendor: 'grok',
    displayName: 'Grok 2',
    pricing: {
      input: 2.0,
      output: 10.0,
    },
    capabilities: {
      reasoning: 88,
      coding: 85,
      creativity: 90,
      speed: 80,
      contextLength: 128,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['general-purpose', 'creative', 'real-time-info'],
  },
  {
    id: 'grok-3',
    vendor: 'grok',
    displayName: 'Grok 3',
    pricing: {
      input: 3.0,
      output: 15.0,
    },
    capabilities: {
      reasoning: 92,
      coding: 90,
      creativity: 92,
      speed: 75,
      contextLength: 128,
    },
    features: {
      vision: true,
      functionCalling: true,
      streaming: true,
    },
    recommendedFor: ['reasoning', 'creative', 'analysis'],
  },
];

// ============================================================
// 模型目录汇总
// ============================================================
export const MODEL_CATALOG: ModelCatalogEntry[] = [
  ...CLAUDE_MODELS,
  ...OPENAI_MODELS,
  ...GEMINI_MODELS,
  ...DEEPSEEK_MODELS,
  ...DOUBAO_MODELS,
  ...GROK_MODELS,
];

// 按场景推荐的模型
export const RECOMMENDED_MODELS = {
  // 深度推理（需要 Extended Thinking）
  'deep-reasoning': [
    'claude-opus-4-20250514',
    'claude-sonnet-4-20250514',
    'o1',
    'deepseek-reasoner',
  ],

  // 成本优化（高性价比）
  'cost-optimized': [
    'deepseek-chat',
    'gpt-4o-mini',
    'gemini-2.0-flash',
    'doubao-1.5-pro-32k',
  ],

  // 快速响应
  'fast-response': [
    'claude-3-5-haiku-20241022',
    'gpt-4o-mini',
    'gemini-2.0-flash',
    'deepseek-chat',
  ],

  // 长上下文
  'long-context': [
    'gemini-1.5-pro',
    'gemini-2.0-flash',
    'doubao-1.5-pro-256k',
    'claude-sonnet-4-20250514',
  ],

  // 编码任务
  coding: ['claude-sonnet-4-20250514', 'deepseek-chat', 'gpt-4o', 'o3-mini'],

  // 通用任务
  'general-purpose': [
    'claude-sonnet-4-20250514',
    'gpt-4o',
    'deepseek-chat',
    'gemini-2.0-flash',
  ],
};
```

#### 11.1.2 模型选择算法

```typescript
/**
 * 根据场景和约束选择最优模型
 */
function selectOptimalModel(
  scenario: string,
  constraints: {
    maxCostPerMToken?: number;
    minReasoningScore?: number;
    minSpeed?: number;
    requiresExtendedThinking?: boolean;
    requiresCacheControl?: boolean;
  },
): ModelCatalogEntry | null {
  // 1. 获取场景推荐模型
  const recommendedIds = RECOMMENDED_MODELS[scenario] || [];

  // 2. 过滤满足约束的模型
  const eligibleModels = MODEL_CATALOG.filter((model) => {
    // 检查是否在推荐列表中
    if (recommendedIds.length > 0 && !recommendedIds.includes(model.id)) {
      return false;
    }

    // 检查成本约束
    if (
      constraints.maxCostPerMToken &&
      model.pricing.input > constraints.maxCostPerMToken
    ) {
      return false;
    }

    // 检查推理能力约束
    if (
      constraints.minReasoningScore &&
      model.capabilities.reasoning < constraints.minReasoningScore
    ) {
      return false;
    }

    // 检查速度约束
    if (
      constraints.minSpeed &&
      model.capabilities.speed < constraints.minSpeed
    ) {
      return false;
    }

    // 检查 Extended Thinking 支持
    if (
      constraints.requiresExtendedThinking &&
      !model.features.extendedThinking
    ) {
      return false;
    }

    // 检查 Cache Control 支持
    if (constraints.requiresCacheControl && !model.features.cacheControl) {
      return false;
    }

    return true;
  });

  if (eligibleModels.length === 0) {
    return null;
  }

  // 3. 按综合评分排序
  return eligibleModels.sort((a, b) => {
    const scoreA = calculateModelScore(a, scenario);
    const scoreB = calculateModelScore(b, scenario);
    return scoreB - scoreA;
  })[0];
}

/**
 * 计算模型综合评分
 */
function calculateModelScore(
  model: ModelCatalogEntry,
  scenario: string,
): number {
  const weights = getScenarioWeights(scenario);

  // 成本评分（越低越好）
  const costScore = 100 - Math.min(model.pricing.input * 10, 100);

  // 能力评分
  const capabilityScore =
    (model.capabilities.reasoning * weights.reasoning +
      model.capabilities.coding * weights.coding +
      model.capabilities.creativity * weights.creativity +
      model.capabilities.speed * weights.speed) /
    (weights.reasoning + weights.coding + weights.creativity + weights.speed);

  // 综合评分
  return costScore * weights.cost + capabilityScore * weights.capability;
}

/**
 * 获取场景权重配置
 */
function getScenarioWeights(scenario: string): Record<string, number> {
  const scenarioWeights: Record<string, Record<string, number>> = {
    'deep-reasoning': {
      cost: 0.2,
      capability: 0.8,
      reasoning: 1.0,
      coding: 0.3,
      creativity: 0.2,
      speed: 0.1,
    },
    'cost-optimized': {
      cost: 0.7,
      capability: 0.3,
      reasoning: 0.3,
      coding: 0.3,
      creativity: 0.2,
      speed: 0.5,
    },
    'fast-response': {
      cost: 0.3,
      capability: 0.7,
      reasoning: 0.2,
      coding: 0.2,
      creativity: 0.2,
      speed: 1.0,
    },
    coding: {
      cost: 0.3,
      capability: 0.7,
      reasoning: 0.4,
      coding: 1.0,
      creativity: 0.2,
      speed: 0.4,
    },
  };

  return (
    scenarioWeights[scenario] || {
      cost: 0.5,
      capability: 0.5,
      reasoning: 0.5,
      coding: 0.5,
      creativity: 0.5,
      speed: 0.5,
    }
  );
}
```

#### 11.1.3 能力标签种子数据（Capability Tags Seed）

```typescript
// prisma/seed/capability-tags.seed.ts
export const CAPABILITY_TAGS_SEED: Prisma.CapabilityTagCreateInput[] = [
  {
    tagId: 'deep-reasoning',
    name: '深度推理',
    description: '需要复杂推理、分析的任务，使用 Extended Thinking',
    category: 'reasoning',
    priority: 100,
    requiredProtocol: 'anthropic-native',
    requiredModels: ['claude-opus-4-20250514', 'claude-sonnet-4-20250514'],
    requiresExtendedThinking: true,
    isBuiltin: true,
  },
  {
    tagId: 'fast-reasoning',
    name: '快速推理',
    description: '需要快速响应的推理任务',
    category: 'reasoning',
    priority: 50,
    requiredProtocol: 'openai-compatible',
    requiredModels: ['gpt-4o', 'claude-sonnet-4-20250514', 'deepseek-chat', 'o3-mini'],
    isBuiltin: true,
  },
  {
    tagId: 'web-search',
    name: '网络搜索',
    description: '需要实时搜索互联网信息',
    category: 'search',
    priority: 80,
    requiredSkills: ['web_search'],
    isBuiltin: true,
  },
  {
    tagId: 'code-execution',
    name: '代码执行',
    description: '需要执行代码并返回结果',
    category: 'code',
    priority: 70,
    requiredSkills: ['code_runner'],
    isBuiltin: true,
  },
  {
    tagId: 'cost-optimized',
    name: '成本优化',
    description: '优先使用高性价比模型，支持 Cache Control',
    category: 'cost',
    priority: 90,
    requiredProtocol: 'anthropic-native',
    requiredModels: ['deepseek-chat', 'gpt-4o-mini', 'gemini-2.0-flash', 'doubao-1.5-pro-32k'],
    requiresCacheControl: true,
    isBuiltin: true,
  },
  {
    tagId: 'long-context',
    name: '长上下文',
    description: '需要处理超长文档或对话历史',
    category: 'context',
    priority: 60,
    requiredProtocol: 'openai-compatible',
    requiredModels: ['gemini-1.5-pro', 'gemini-2.0-flash', 'doubao-1.5-pro-256k'],
    isBuiltin: true,
  },
  {
    tagId: 'vision',
    name: '视觉理解',
    description: '需要处理图像、视频等多模态内容',
    category: 'vision',
    priority: 75,
    requiredModels: ['gpt-4o', 'claude-sonnet-4-20250514', 'gemini-2.0-flash'],
    requiresVision: true,
    isBuiltin: true,
  },
];
```

#### 11.1.4 Fallback 链种子数据（Fallback Chains Seed）

```typescript
// prisma/seed/fallback-chains.seed.ts
export const FALLBACK_CHAINS_SEED: Prisma.FallbackChainCreateInput[] = [
  {
    chainId: 'default',
    name: '默认 Fallback 链',
    description: '通用场景的模型降级策略',
    models: [
      { vendor: 'anthropic', model: 'claude-sonnet-4-20250514', protocol: 'openai-compatible' },
      { vendor: 'openai', model: 'gpt-4o', protocol: 'openai-compatible' },
      { vendor: 'deepseek', model: 'deepseek-chat', protocol: 'openai-compatible' },
    ],
    triggerStatusCodes: [429, 500, 502, 503, 504],
    triggerErrorTypes: ['rate_limit', 'overloaded', 'timeout'],
    triggerTimeoutMs: 60000,
    maxRetries: 3,
    retryDelayMs: 2000,
    preserveProtocol: false,
    isBuiltin: true,
  },
  {
    chainId: 'deep-reasoning',
    name: '深度推理 Fallback 链',
    description: '深度推理任务的模型降级策略，优先保持 Extended Thinking',
    models: [
      { vendor: 'anthropic', model: 'claude-sonnet-4-20250514', protocol: 'anthropic-native', features: { extendedThinking: true } },
      { vendor: 'anthropic', model: 'claude-opus-4-20250514', protocol: 'anthropic-native', features: { extendedThinking: true } },
      { vendor: 'openai', model: 'o1', protocol: 'openai-compatible' },
      { vendor: 'deepseek', model: 'deepseek-reasoner', protocol: 'openai-compatible' },
    ],
    triggerStatusCodes: [429, 500, 502, 503, 504],
    triggerErrorTypes: ['rate_limit', 'overloaded', 'timeout'],
    triggerTimeoutMs: 120000,
    maxRetries: 3,
    retryDelayMs: 3000,
    preserveProtocol: false,
    isBuiltin: true,
  },
  {
    chainId: 'cost-optimized',
    name: '成本优化 Fallback 链',
    description: '优先使用低成本模型',
    models: [
      { vendor: 'deepseek', model: 'deepseek-chat', protocol: 'openai-compatible' },
      { vendor: 'openai', model: 'gpt-4o-mini', protocol: 'openai-compatible' },
      { vendor: 'google', model: 'gemini-2.0-flash', protocol: 'openai-compatible' },
      { vendor: 'doubao', model: 'doubao-1.5-pro-32k', protocol: 'openai-compatible' },
    ],
    triggerStatusCodes: [429, 500, 502, 503, 504],
    triggerErrorTypes: ['rate_limit', 'overloaded', 'timeout'],
    triggerTimeoutMs: 30000,
    maxRetries: 3,
    retryDelayMs: 1000,
    preserveProtocol: true,
    isBuiltin: true,
  },
  {
    chainId: 'fast-response',
    name: '快速响应 Fallback 链',
    description: '优先使用响应速度快的模型',
    models: [
      { vendor: 'anthropic', model: 'claude-3-5-haiku-20241022', protocol: 'openai-compatible' },
      { vendor: 'openai', model: 'gpt-4o-mini', protocol: 'openai-compatible' },
      { vendor: 'google', model: 'gemini-2.0-flash', protocol: 'openai-compatible' },
    ],
    triggerStatusCodes: [429, 500, 502, 503, 504],
    triggerErrorTypes: ['rate_limit', 'overloaded', 'timeout'],
    triggerTimeoutMs: 15000,
    maxRetries: 2,
    retryDelayMs: 500,
    preserveProtocol: true,
    isBuiltin: true,
  },
];
```

#### 11.1.5 成本策略种子数据（Cost Strategies Seed）

```typescript
// prisma/seed/cost-strategies.seed.ts
export const COST_STRATEGIES_SEED: Prisma.CostStrategyCreateInput[] = [
  {
    strategyId: 'lowest-cost',
    name: '最低成本',
    description: '优先选择成本最低的模型，适合预算有限的场景',
    costWeight: 0.8,
    performanceWeight: 0.1,
    capabilityWeight: 0.1,
    maxCostPerRequest: 0.01,
    scenarioWeights: {
      reasoning: 0.2,
      coding: 0.2,
      creativity: 0.2,
      speed: 0.6,
    },
    isBuiltin: true,
  },
  {
    strategyId: 'best-value',
    name: '最佳性价比',
    description: '在成本和能力之间取得平衡',
    costWeight: 0.5,
    performanceWeight: 0.2,
    capabilityWeight: 0.3,
    scenarioWeights: {
      reasoning: 0.4,
      coding: 0.4,
      creativity: 0.3,
      speed: 0.4,
    },
    isBuiltin: true,
  },
  {
    strategyId: 'performance-first',
    name: '性能优先',
    description: '优先选择能力最强的模型，不考虑成本',
    costWeight: 0.1,
    performanceWeight: 0.3,
    capabilityWeight: 0.6,
    minCapabilityScore: 85,
    scenarioWeights: {
      reasoning: 0.8,
      coding: 0.7,
      creativity: 0.5,
      speed: 0.3,
    },
    isBuiltin: true,
  },
  {
    strategyId: 'balanced',
    name: '均衡策略',
    description: '综合考虑成本、性能和能力',
    costWeight: 0.4,
    performanceWeight: 0.3,
    capabilityWeight: 0.3,
    scenarioWeights: {
      reasoning: 0.5,
      coding: 0.5,
      creativity: 0.4,
      speed: 0.5,
    },
    isBuiltin: true,
  },
];
```

#### 11.1.6 数据库种子脚本

```typescript
// prisma/seed/index.ts
import { PrismaClient } from '@prisma/client';
import { MODEL_CATALOG_SEED } from './model-catalog.seed';
import { CAPABILITY_TAGS_SEED } from './capability-tags.seed';
import { FALLBACK_CHAINS_SEED } from './fallback-chains.seed';
import { COST_STRATEGIES_SEED } from './cost-strategies.seed';

const prisma = new PrismaClient();

async function main() {
  console.log('Seeding database...');

  // 1. 种子模型目录
  console.log('Seeding ModelCatalog...');
  for (const model of MODEL_CATALOG_SEED) {
    await prisma.modelCatalog.upsert({
      where: { modelId: model.modelId },
      update: model,
      create: model,
    });
  }

  // 2. 种子能力标签
  console.log('Seeding CapabilityTags...');
  for (const tag of CAPABILITY_TAGS_SEED) {
    await prisma.capabilityTag.upsert({
      where: { tagId: tag.tagId },
      update: tag,
      create: tag,
    });
  }

  // 3. 种子 Fallback 链
  console.log('Seeding FallbackChains...');
  for (const chain of FALLBACK_CHAINS_SEED) {
    await prisma.fallbackChain.upsert({
      where: { chainId: chain.chainId },
      update: chain,
      create: chain,
    });
  }

  // 4. 种子成本策略
  console.log('Seeding CostStrategies...');
  for (const strategy of COST_STRATEGIES_SEED) {
    await prisma.costStrategy.upsert({
      where: { strategyId: strategy.strategyId },
      update: strategy,
      create: strategy,
    });
  }

  console.log('Database seeding completed!');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

#### 11.1.7 管理员配置界面

管理员可以通过以下方式管理配置：

1. **管理后台 UI**（`/admin/routing-config`）
   - 模型目录管理：添加/编辑/删除模型，调整定价和能力评分
   - 能力标签管理：创建自定义标签，配置路由规则
   - Fallback 链管理：配置降级策略
   - 成本策略管理：定义成本优化策略

2. **API 端点**（参考 7.1.3 - 7.1.6）
   - RESTful API 支持 CRUD 操作
   - 支持批量导入/导出配置

3. **配置同步**
   - 支持从提供商 API 自动同步模型信息
   - 定期更新模型定价（可配置定时任务）

```typescript
// 管理员配置同步服务
@Injectable()
export class AdminConfigSyncService {
  /**
   * 从 OpenAI API 同步模型列表
   */
  async syncOpenAIModels(): Promise<void> {
    const models = await this.openaiClient.listModels();
    for (const model of models) {
      await this.modelCatalogDb.upsert({
        where: { modelId: model.id },
        update: { isActive: true },
        create: {
          modelId: model.id,
          vendor: 'openai',
          displayName: model.id,
          // ... 其他字段使用默认值
        },
      });
    }
  }

  /**
   * 从 Anthropic API 同步模型列表
   */
  async syncAnthropicModels(): Promise<void> {
    // Anthropic 没有 list models API，使用预定义列表
    const models = ['claude-opus-4-20250514', 'claude-sonnet-4-20250514', 'claude-3-5-haiku-20241022'];
    // ...
  }

  /**
   * 更新模型定价（从外部数据源）
   */
  async updateModelPricing(modelId: string, pricing: ModelPricing): Promise<void> {
    await this.modelCatalogDb.update({
      where: { modelId },
      data: {
        inputPrice: pricing.input,
        outputPrice: pricing.output,
        cacheReadPrice: pricing.cacheRead,
        cacheWritePrice: pricing.cacheWrite,
        thinkingPrice: pricing.thinking,
      },
    });
  }
}
```

### 11.2 参考文档

- [Anthropic API Reference](https://docs.anthropic.com/en/api/messages)
- [Anthropic Extended Thinking](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)
- [Anthropic Prompt Caching](https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching)
- [OpenClaw 配置文件示例](./openclaw%20配置文件实例.md)

### 11.3 相关代码文件

- [proxy.service.ts](../apps/api/src/modules/proxy/services/proxy.service.ts) - 代理核心服务
- [vendor.config.ts](../apps/api/src/modules/proxy/config/vendor.config.ts) - 提供商配置
- [token-extractor.service.ts](../apps/api/src/modules/proxy/services/token-extractor.service.ts) - Token 提取
- [provider.schema.ts](../packages/contracts/src/schemas/provider.schema.ts) - 提供商定义
- [skill.schema.ts](../packages/contracts/src/schemas/skill.schema.ts) - Skills 定义
- [openclaw.client.ts](../apps/api/libs/infra/clients/internal/openclaw/openclaw.client.ts) - OpenClaw 客户端

### 11.4 架构总览图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              OpenClaw Bot Container                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  config.yaml                                                           │ │
│  │  ├── llm.routing (能力标签路由)                                        │ │
│  │  ├── llm.fallback (多模型 Fallback)                                   │ │
│  │  ├── llm.cost_control (成本控制)                                      │ │
│  │  └── skills (Skills 配置)                                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│  ┌───────────────────────────────────▼───────────────────────────────────┐ │
│  │  OpenClawClient                                                        │ │
│  │  ├── RoutingEngine (路由引擎)                                          │ │
│  │  ├── FallbackEngine (Fallback 引擎)                                   │ │
│  │  └── CostOptimizer (成本优化器)                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ X-Routing-Hint / X-Cost-Strategy
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Proxy Gateway                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  RoutingEngineService                                                  │ │
│  │  ├── parseCapabilityRequirements() - 解析能力需求                      │ │
│  │  ├── selectRoute() - 选择路由                                          │ │
│  │  └── checkSkillsAvailability() - 检查 Skills 可用性                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  FallbackEngineService                                                 │ │
│  │  ├── executeWithFallback() - 带 Fallback 执行                         │ │
│  │  └── shouldFallback() - 判断是否触发 Fallback                         │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  CostTrackerService                                                    │ │
│  │  ├── recordCost() - 记录成本                                           │ │
│  │  ├── checkBudget() - 检查预算                                          │ │
│  │  └── triggerAutoDowngrade() - 触发自动降级                            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                    │                                       │
                    ▼                                       ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────┐
│   OpenAI-compatible Channel       │   │   Anthropic Native Channel        │
│   (默认通道)                       │   │   (Extended Thinking / Cache)     │
│   ├── 64+ 提供商                  │   │   ├── Extended Thinking           │
│   ├── Skills (web_search, etc.)   │   │   └── Cache Control               │
│   └── Function Calling            │   │                                   │
└───────────────────────────────────┘   └───────────────────────────────────┘
```
